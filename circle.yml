---
machine:
  environment:
    AWS_REGION: "eu-west-2"
    FACTER_cidr_block: "192.168.0.0/16"
    FACTER_vpc_prefix: "D1"
    PUPPET_ENVIRONMENT: "d1euw2"

dependencies:
  cache_directories:
    - "/opt/circleci/.rvm"
    - "~/.puppetlabs"
    - "./Puppetfile.lock"
  override:
    - "bundle install"
    - "librarian-puppet install --path /home/ubuntu/.puppetlabs/etc/code/environments/${PUPPET_ENVIRONMENT} --verbose"

test:
  override:
     - "bundle exec rake release_checks"

compile:
  override:
    - "bundle exec rake build"

deployment:
  init:
    branch: /.*-init/
    commands:
      - "puppet module install --force --verbose pkg/locp-awsiac-0.1.0.tar.gz --modulepath /home/ubuntu/.puppetlabs/etc/code/environments/${PUPPET_ENVIRONMENT}"
      - "FACTER_ensure=present FACTER_region=${AWS_REGION} ./puppet_wrapper.sh"
  destroy:
    branch: /.*-destroy/
    commands:
      - "puppet module install --force --verbose pkg/locp-awsiac-0.1.0.tar.gz --modulepath /home/ubuntu/.puppetlabs/etc/code/environments/${PUPPET_ENVIRONMENT}"
      - "FACTER_ensure=absent FACTER_region=${AWS_REGION} ./puppet_wrapper.sh"
